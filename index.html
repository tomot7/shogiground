<!doctype html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="assets/css/shogiground.css" />
    <link rel="stylesheet" href="assets/css/hands.css" />
    <link rel="stylesheet" href="assets/css/themes/wood-grid.css" />
    <link rel="stylesheet" href="assets/css/pieces/ryoko.css" />
    <style>
        body {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .board-wrap {
            width: 400px;
            height: 400px;
        }
    </style>
</head>

<body>
    <div class="wrap" style="display: flex">
        <div id="hand-top" class="sg-hand-wrap"></div>
        <div id='shogi-board' class="board-wrap main-board">
            <div class="board sg-wrap"></div>
        </div>
        <div id="hand-bottom" class="sg-hand-wrap"></div>
    </div>
    <script src="dist/shogiground.js"></script>
    <script>
        // URLからクエリストリングを取得
        const queryString = window.location.search;

        // URLSearchParamsを使用してクエリストリングのパラメータを解析
        const urlParams = new URLSearchParams(queryString);
        console.log(urlParams)

        // 盤の縦方向位置についての、日本語⇔SFEN対応辞書
        const positionDict = {
            "一": "a",
            "二": "b",
            "三": "c",
            "四": "d",
            "五": "e",
            "六": "f",
            "七": "g",
            "八": "h",
            "九": "i",
        }

        let initBoard = ""
        let initHands = ""
        // 手順を格納する
        let moves = []

        // 全てのパラメータを取得
        for (let param of urlParams) {
            console.log(param);
            if (param[0] === "init") {
                // 盤面を初期化する
                const sfenSplitedSpace = param[1].split(" ")
                initBoard = sfenSplitedSpace[0]
                initHands = sfenSplitedSpace[2]
            } else if (param[0] === "moves") {
                // 手順をshogigroundで使用できる形に格納する
                const movesStringArr = param[1].split("/")
                console.log(movesStringArr)
                let regex = /\(([^)]+)\)/;
                movesStringArr.forEach(item => {
                    let match = item.match(regex);
                    let inside = match ? match[1].split("") : null;
                    let outside = item.split(regex).filter((_, i) => i % 2 === 0)[0].split("");
                    const move = {
                        "before": inside[0] + positionDict[inside[1]],
                        "after": outside[0] + positionDict[outside[1]]
                    }
                    moves.push(move)
                })
            }

        }
        let sg = Shogiground(
            {
                sfen: {
                    board: initBoard,
                    hands: initHands,
                },
                movable: {
                    free: false
                },
                droppable: {
                    free: false
                }
            },
            {
                board: document.getElementById('shogi-board'),
                hands: {
                    bottom: document.getElementById('hand-bottom'),
                    top: document.getElementById('hand-top'),
                },
            },
        );

        moves.forEach((move, index) => {
            setTimeout(function () {
                if (sg.state.pieces.get(move.after)) {
                    sg.addToHand({ role: sg.state.pieces.get(move.after).role, color: sg.state.pieces.get(move.after).color })
                }
                sg.move(move.before, move.after)
            }, 2000 * index);
        })
    </script>
</body>

</html>